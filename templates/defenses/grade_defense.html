{% extends 'base.html' %}
{% load static %}

{% block title %}Notation de soutenance - {{ project.title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <!-- En-tête -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-star"></i> Notation de soutenance
                    </h4>
                </div>
                <div class="card-body">
                    <h5>{{ project.title }}</h5>
                    <p class="text-muted mb-2">
                        <strong>Date :</strong> {{ defense.date|date:"d/m/Y" }} à {{ defense.time|time:"H:i" }}
                    </p>
                    <p class="text-muted mb-2">
                        <strong>Lieu :</strong> {{ defense.location }}
                    </p>
                    <p class="text-muted mb-2">
                        <strong>Votre rôle :</strong> 
                        <span class="badge badge-info">{{ jury_member.get_role_display }}</span>
                    </p>
                </div>
            </div>

            <!-- Informations sur l'équipe -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-users"></i> Équipe</h5>
                </div>
                <div class="card-body">
                    {% if project.team %}
                        <p><strong>Étudiant(s) :</strong></p>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-user"></i> {{ project.team.student1.get_full_name }} ({{ project.team.student1.filiere }})</li>
                            {% if project.team.student2 %}
                                <li><i class="fas fa-user"></i> {{ project.team.student2.get_full_name }} ({{ project.team.student2.filiere }})</li>
                            {% endif %}
                        </ul>
                    {% endif %}
                    
                    <p class="mt-3"><strong>Encadreur :</strong> {{ project.assignment.subject.supervisor.get_full_name }}</p>
                </div>
            </div>

            <!-- Jury complet -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-gavel"></i> Composition du jury</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Membre</th>
                                <th>Rôle</th>
                                <th>Note</th>
                                <th>Statut</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for member in defense.defense_jury_members.all %}
                            <tr {% if member.id == jury_member.id %}class="table-primary"{% endif %}>
                                <td>{{ member.teacher.get_full_name }}</td>
                                <td>{{ member.get_role_display }}</td>
                                <td>
                                    {% if member.grade %}
                                        <strong>{{ member.grade }}/20</strong>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if member.grade %}
                                        <span class="badge badge-success">Noté</span>
                                    {% else %}
                                        <span class="badge badge-warning">En attente</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Formulaire de notation -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-edit"></i> Votre notation</h5>
                </div>
                <div class="card-body">
                    {% if jury_member.grade %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            Vous avez déjà attribué la note de <strong>{{ jury_member.grade }}/20</strong>.
                            Vous pouvez la modifier ci-dessous.
                        </div>
                    {% endif %}

                    <form method="post">
                        {% csrf_token %}
                        
                        <div class="form-group">
                            <label for="grade">
                                <strong>Note sur 20 <span class="text-danger">*</span></strong>
                            </label>
                            <input 
                                type="number" 
                                class="form-control" 
                                id="grade" 
                                name="grade" 
                                min="0" 
                                max="20" 
                                step="0.25" 
                                value="{{ jury_member.grade|default:'' }}"
                                required
                                placeholder="Ex: 15.5"
                            >
                            <small class="form-text text-muted">
                                Entrez une note entre 0 et 20 (décimales autorisées : 0.25, 0.5, 0.75)
                            </small>
                        </div>

                        <div class="form-group">
                            <label for="comments">
                                <strong>Commentaires et observations</strong>
                            </label>
                            <textarea 
                                class="form-control" 
                                id="comments" 
                                name="comments" 
                                rows="5"
                                placeholder="Vos observations sur la présentation, la qualité du travail, les réponses aux questions..."
                            >{{ jury_member.comments|default:'' }}</textarea>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{% url 'defenses:defense_detail' defense.pk %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Retour
                            </a>
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-save"></i> Enregistrer la note
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Note finale si toutes les notes sont saisies -->
            {% if defense.final_grade %}
            <div class="card border-success mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-trophy"></i> Note finale</h5>
                </div>
                <div class="card-body text-center">
                    <h2 class="display-3 text-success">{{ defense.final_grade }}/20</h2>
                    <p class="lead">Moyenne des notes du jury</p>
                    <p class="text-muted">
                        <small>Toutes les notes ont été saisies et le projet a été archivé.</small>
                    </p>
                </div>
            </div>
            {% endif %}

        </div>
    </div>
</div>

<style>
    .table-primary {
        background-color: #cfe2ff !important;
    }
</style>
{% endblock %}
